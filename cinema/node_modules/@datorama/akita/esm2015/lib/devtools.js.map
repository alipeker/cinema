{"version":3,"file":"devtools.js","sourceRoot":"ng://@datorama/akita/","sources":["lib/devtools.ts"],"names":[],"mappings":"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","sourcesContent":["import { currentAction, setSkipAction } from './actions';\nimport { isDefined } from './isDefined';\nimport { $$addStore, $$deleteStore, $$updateStore } from './dispatchers';\nimport { __stores__ } from './stores';\nimport { capitalize } from './capitalize';\nimport { isNotBrowser } from './root';\n\nexport type DevtoolsOptions = {\n  /** instance name visible in devtools */\n  name: string;\n  /**  maximum allowed actions to be stored in the history tree */\n  maxAge: number;\n  latency: number;\n  actionsBlacklist: string[];\n  actionsWhitelist: string[];\n  storesWhitelist: string[];\n  shouldCatchErrors: boolean;\n  logTrace: boolean;\n  predicate: (state: any, action: any) => boolean;\n  shallow: boolean;\n  sortAlphabetically: boolean;\n};\nlet subs = [];\n\nexport type NgZoneLike = { run: any };\n\nexport function akitaDevtools(ngZone: NgZoneLike, options?: Partial<DevtoolsOptions>);\nexport function akitaDevtools(options?: Partial<DevtoolsOptions>);\nexport function akitaDevtools(ngZoneOrOptions?: NgZoneLike | Partial<DevtoolsOptions>, options: Partial<DevtoolsOptions> = {}) {\n  if (isNotBrowser) return;\n\n  if (!(window as any).__REDUX_DEVTOOLS_EXTENSION__) {\n    return;\n  }\n\n  subs.length &&\n    subs.forEach((s) => {\n      if (s.unsubscribe) {\n        s.unsubscribe();\n      } else {\n        s && s();\n      }\n    });\n\n  const isAngular = ngZoneOrOptions && ngZoneOrOptions['run'];\n\n  if (!isAngular) {\n    ngZoneOrOptions = ngZoneOrOptions || {};\n    (ngZoneOrOptions as any).run = (cb) => cb();\n    options = ngZoneOrOptions as Partial<DevtoolsOptions>;\n  }\n\n  const defaultOptions: Partial<DevtoolsOptions> & { name: string } = { name: 'Akita', shallow: true, storesWhitelist: [] };\n  const merged = Object.assign({}, defaultOptions, options);\n  const storesWhitelist = merged.storesWhitelist;\n  const devTools = (window as any).__REDUX_DEVTOOLS_EXTENSION__.connect(merged);\n  let appState = {};\n\n  const isAllowed = (storeName) => {\n    if (!storesWhitelist.length) {\n      return true;\n    }\n\n    return storesWhitelist.indexOf(storeName) > -1;\n  };\n\n  subs.push(\n    $$addStore.subscribe((storeName) => {\n      if (isAllowed(storeName) === false) return;\n      appState = {\n        ...appState,\n        [storeName]: __stores__[storeName]._value(),\n      };\n      devTools.send({ type: `[${capitalize(storeName)}] - @@INIT` }, appState);\n    })\n  );\n\n  subs.push(\n    $$deleteStore.subscribe((storeName) => {\n      if (isAllowed(storeName) === false) return;\n      delete appState[storeName];\n      devTools.send({ type: `[${storeName}] - Delete Store` }, appState);\n    })\n  );\n\n  subs.push(\n    $$updateStore.subscribe(({ storeName, action }) => {\n      if (isAllowed(storeName) === false) return;\n      const { type, entityIds, skip, ...rest } = action;\n\n      const payload = rest.payload;\n      if (skip) {\n        setSkipAction(false);\n        return;\n      }\n\n      const store = __stores__[storeName];\n      if (!store) {\n        return;\n      }\n\n      if (options.shallow === false && appState[storeName]) {\n        const isEqual = JSON.stringify(store._value()) === JSON.stringify(appState[storeName]);\n        if (isEqual) return;\n      }\n\n      appState = {\n        ...appState,\n        [storeName]: store._value(),\n      };\n\n      const normalize = capitalize(storeName);\n      let msg = isDefined(entityIds) ? `[${normalize}] - ${type} (ids: ${entityIds})` : `[${normalize}] - ${type}`;\n\n      if (options.logTrace) {\n        console.group(msg);\n        console.trace();\n        console.groupEnd();\n      }\n\n      if (options.sortAlphabetically) {\n        const sortedAppState = Object.keys(appState)\n          .sort()\n          .reduce((acc, storeName) => {\n            acc[storeName] = appState[storeName];\n            return acc;\n          }, {});\n\n        devTools.send({ type: msg, ...payload }, sortedAppState)\n        return;\n      }\n\n      devTools.send({ type: msg, ...payload }, appState)\n    })\n  );\n\n  subs.push(\n    devTools.subscribe((message) => {\n      if (message.type === 'DISPATCH') {\n        const payloadType = message.payload.type;\n\n        if (payloadType === 'COMMIT') {\n          devTools.init(appState);\n          return;\n        }\n\n        if (message.state) {\n          const rootState = JSON.parse(message.state);\n          for (let i = 0, keys = Object.keys(rootState); i < keys.length; i++) {\n            const storeName = keys[i];\n            if (__stores__[storeName]) {\n              (ngZoneOrOptions as NgZoneLike).run(() => {\n                __stores__[storeName]._setState(() => rootState[storeName], false);\n              });\n            }\n          }\n        }\n      }\n    })\n  );\n}\n"]}