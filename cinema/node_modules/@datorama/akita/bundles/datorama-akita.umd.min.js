!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("rxjs/operators"),require("rxjs")):"function"==typeof define&&define.amd?define("@datorama/akita",["exports","rxjs/operators","rxjs"],e):e(((t=t||self).datorama=t.datorama||{},t.datorama.akita={}),t.rxjs.operators,t.rxjs)}(this,(function(t,e,n){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)};function i(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}var o=function(){return(o=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function s(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(n[r[i]]=t[r[i]])}return n}function a(t,e,n,r){var i,o=arguments.length,s=o<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var a=t.length-1;a>=0;a--)(i=t[a])&&(s=(o<3?i(s):o>3?i(e,n,s):i(e,n))||s);return o>3&&s&&Object.defineProperty(e,n,s),s}function u(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)}Object.create;function c(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],r=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function p(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var r,i,o=n.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(r=o.next()).done;)s.push(r.value)}catch(t){i={error:t}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return s}function f(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(p(arguments[e]));return t}Object.create;var h={type:null,entityIds:null,skip:!1,payload:null},l=!1;function y(){l=!1}function d(t,e,n){v(t,e,n),l=!0}function v(t,e,n){!1===l&&(h.type=t,h.entityIds=e,h.payload=n)}function g(t){void 0===t&&(t=!0),h.skip=t}function b(t,e){return function(n,r,i){var o=i.value;return i.value=function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];return d(t,e),o.apply(this,n)},i}}function m(t,e){return t.hasOwnProperty(e)}function S(t){return Array.isArray(t)}function E(t){return t.hasOwnProperty("active")}function P(t){return S(t)}function _(t){var e=t.active,n=t.ids,r=t.entities;return P(e)?A(e,n):!1===m(r,e)?null:e}function A(t,e){var n=t.filter((function(t){return e.indexOf(t)>-1}));return n.length===t.length?t:n}function O(t){var e,n,r=t.state,i=t.entities,s=t.idKey,a=t.options,u=void 0===a?{}:a,p=t.preAddEntity,h={},l=[],y=!1;try{for(var d=c(i),v=d.next();!v.done;v=d.next()){var g=v.value;if(!1===m(r.entities,g[s])){var b=p(g),S=b[s];h[S]=b,u.prepend?l.unshift(S):l.push(S),y=!0}}}catch(t){e={error:t}}finally{try{v&&!v.done&&(n=d.return)&&n.call(d)}finally{if(e)throw e.error}}return y?{newState:o(o({},r),{entities:o(o({},r.entities),h),ids:u.prepend?f(l,r.ids):f(r.ids,l)}),newIds:l}:null}function w(t){return null==t}function I(t){return w(t)?[]:Array.isArray(t)?t:[t]}function j(t,e,n){void 0===n&&(n={});var r=I(e),i=t||[];return n.prepend?f(r,i):f(i,r)}function C(t){return!!S(t)&&0===t.length}function k(t){return"function"==typeof t}function x(t,e,n){var r,i,o,s,a=[];if(k(e))try{for(var u=c(t),p=u.next();!p.done;p=u.next()){!0===e(y=p.value)&&a.push(y)}}catch(t){r={error:t}}finally{try{p&&!p.done&&(i=u.return)&&i.call(u)}finally{if(r)throw r.error}}else{var f=I(e).reduce((function(t,e){return t.add(e)}),new Set);try{for(var h=c(t),l=h.next();!l.done;l=h.next()){var y=l.value;f.has(y[n])&&a.push(y)}}catch(t){o={error:t}}finally{try{l&&!l.done&&(s=h.return)&&s.call(h)}finally{if(o)throw o.error}}}return a}function U(){return e.distinctUntilChanged((function(t,e){return t===e||!(!S(t)||!S(e))&&(!(!C(t)||!C(e))||t.length===e.length&&!1===e.some((function(e,n){return t[n]!==e})))}))}function N(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}function F(t){return function(e,n){return e[t]===n[t]}}function V(t,e,n,r){var i;if(void 0===r&&(r="id"),k(e))i=e;else{var s=I(e);i=function(t){return!0===s.includes(N(t)?t[r]:t)}}return t.map((function(t,e){return!0===i(t,e)?N(t)?o(o({},t),n):n:t}))}var D={resettable:!1,ttl:null,producerFn:void 0};function K(){return D}function R(t){return!1===w(t)}var B=new n.Subject,M=new n.ReplaySubject(50,5e3),H=new n.Subject;function $(t){B.next(t)}function L(t){M.next(t)}function Q(t,e){H.next({storeName:t,action:e})}var q="undefined"!=typeof window,z=!q,J=function(){try{return"undefined"!=typeof localStorage}catch(t){return!1}},W={},X={};function Y(t){return t&&t.charAt(0).toUpperCase()+t.slice(1)}q&&(window.$$stores=W,window.$$queries=X);var G,Z,tt=[];function et(e,n){return void 0===n&&(n=t.Order.ASC),function(r,i){if(!r.hasOwnProperty(e)||!i.hasOwnProperty(e))return 0;var o="string"==typeof r[e]?r[e].toUpperCase():r[e],s="string"==typeof i[e]?i[e].toUpperCase():i[e],a=0;return o>s?a=1:o<s&&(a=-1),n==t.Order.DESC?-1*a:a}}function nt(t,e){for(var n=[],r=t.ids,i=t.entities,o=e.filterBy,s=e.limitTo,a=e.sortBy,u=e.sortByOrder,c=function(t){var e=i[r[t]];if(!o)return n.push(e),"continue";I(o).every((function(n){return n(e,t)}))&&n.push(e)},p=0;p<r.length;p++)c(p);if(a){var f=k(a)?a:et(a,u);n=n.sort((function(e,n){return f(e,n,t)}))}var h=Math.min(s||n.length,n.length);return h===n.length?n:n.slice(0,h)}function rt(t,e){var n={},r=e.filterBy,i=e.limitTo,o=t.ids,s=t.entities;if(!r&&!i)return s;var a=!1===w(i);if(r&&a)for(var u=0,c=function(t,e){if(u===i)return"break";var a=o[t],c=s[a];I(r).every((function(e){return e(c,t)}))&&(n[a]=c,u++)},p=0,f=o.length;p<f;p++){if("break"===c(p))break}else{var h=Math.min(i||o.length,o.length),l=function(t){var e=o[t],i=s[e];if(!r)return n[e]=i,"continue";I(r).every((function(e){return e(i,t)}))&&(n[e]=i)};for(p=0;p<h;p++)l(p)}return n}(G=t.Order||(t.Order={})).ASC="asc",G.DESC="desc",(Z=t.EntityActions||(t.EntityActions={})).Set="Set",Z.Add="Add",Z.Update="Update",Z.Remove="Remove";var it=function(){};function ot(){return t.__DEV__}function st(t,e,n){var r;if(S(t))r=t;else if(N(t)){if(w(n))return;t=Object.assign({wrap:!0},t);var i=e.indexOf(n);if(t.prev){var o=0===i;if(o&&!t.wrap)return;r=o?e[e.length-1]:e[i-1]}else if(t.next){var s=e.length===i+1;if(s&&!t.wrap)return;r=s?e[0]:e[i+1]}}else{if(t===n)return;r=t}return r}t.__DEV__=!0;var at=function(){return{entities:{},ids:[],loading:!0,error:null}};function ut(t){return void 0===t}function ct(t){var e,n,r=t.state,i=t.ids;if(w(i))return pt(r);var s=r.entities,a={};try{for(var u=c(r.ids),p=u.next();!p.done;p=u.next()){var f=p.value;!1===i.includes(f)&&(a[f]=s[f])}}catch(t){e={error:t}}finally{try{p&&!p.done&&(n=u.return)&&n.call(u)}finally{if(e)throw e.error}}var h=o(o({},r),{entities:a,ids:r.ids.filter((function(t){return!1===i.includes(t)}))});return E(r)&&(h.active=_(h)),h}function pt(t){return o(o({},t),{entities:{},ids:[],active:P(t.active)?[]:null})}function ft(t,e,n){var r,i,o={entities:{},ids:[]};try{for(var s=c(t),a=s.next();!a.done;a=s.next()){var u=n(a.value);o.entities[u[e]]=u,o.ids.push(u[e])}}catch(t){r={error:t}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(r)throw r.error}}return o}function ht(t){return t.entities&&t.ids}function lt(t,e){var n,r,i={};try{for(var o=c(Object.keys(t)),s=o.next();!s.done;s=o.next()){var a=s.value;i[a]=e(t[a])}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return i}function yt(t){var e,n,r=t.state,i=t.entities,s=t.idKey,a=t.preAddEntity,u=t.isNativePreAdd;if(S(i)){var c=ft(i,s,a);e=c.entities,n=c.ids}else ht(i)?(e=u?i.entities:lt(i.entities,a),n=i.ids):(e=u?i:lt(i,a),n=Object.keys(e).map((function(t){return isNaN(t)?t:Number(t)})));var p=o(o({},r),{entities:e,ids:n,loading:!1});return E(r)&&(p.active=_(p)),p}function dt(t){Object.freeze(t);var e="function"==typeof t,n=Object.prototype.hasOwnProperty;return Object.getOwnPropertyNames(t).forEach((function(r){!n.call(t,r)||e&&("caller"===r||"callee"===r||"arguments"===r)||null===t[r]||"object"!=typeof t[r]&&"function"!=typeof t[r]||Object.isFrozen(t[r])||dt(t[r])})),t}var vt=function(t){function e(e){return t.call(this,e)||this}return i(e,t),e}(Error);function gt(t){return null!=t&&""+t!="false"}function bt(t){return gt(t)&&"Object"===t.constructor.name}var mt=new n.Subject,St=new n.BehaviorSubject(!1),Et={activeTransactions:0,batchTransaction:null};function Pt(){At()||(Et.batchTransaction=new n.Subject),Et.activeTransactions++,St.next(!0)}function _t(){0==--Et.activeTransactions&&(Et.batchTransaction.next(!0),Et.batchTransaction.complete(),St.next(!1),mt.next(!0))}function At(){return Et.activeTransactions>0}function Ot(){return Et.batchTransaction?Et.batchTransaction.asObservable():n.of(!0)}function wt(t,e){void 0===e&&(e=void 0),Pt();try{return t.apply(e)}finally{d("@Transaction"),_t()}}function It(){return function(t,e,n){var r=n.value;return n.value=function(){for(var t=this,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return wt((function(){return r.apply(t,e)}),this)},n}}var jt=function(){function r(t,e){void 0===e&&(e={}),this.options=e,this.inTransaction=!1,this.cache={active:new n.BehaviorSubject(!1),ttl:null},this.onInit(t)}return r.prototype.setLoading=function(t){void 0===t&&(t=!1),t!==this._value().loading&&(ot()&&v("Set Loading"),this._setState((function(e){return o(o({},e),{loading:t})})))},r.prototype.setHasCache=function(t,e){var n=this;if(void 0===e&&(e={restartTTL:!1}),t!==this.cache.active.value&&this.cache.active.next(t),e.restartTTL){var r=this.getCacheTTL();r&&(null!==this.cache.ttl&&clearTimeout(this.cache.ttl),this.cache.ttl=setTimeout((function(){return n.setHasCache(!1)}),r))}},r.prototype.getValue=function(){return this.storeValue},r.prototype.setError=function(t){t!==this._value().error&&(ot()&&v("Set Error"),this._setState((function(e){return o(o({},e),{error:t})})))},r.prototype._select=function(t){return this.store.asObservable().pipe(e.map((function(e){return t(e.state)})),e.distinctUntilChanged())},r.prototype._value=function(){return this.storeValue},r.prototype._cache=function(){return this.cache.active},Object.defineProperty(r.prototype,"config",{get:function(){return this.constructor.akitaConfig||{}},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"storeName",{get:function(){return this.config.storeName||this.options.storeName||this.options.name},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"deepFreeze",{get:function(){return this.config.deepFreezeFn||this.options.deepFreezeFn||dt},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"cacheConfig",{get:function(){return this.config.cache||this.options.cache},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"_producerFn",{get:function(){return this.config.producerFn||this.options.producerFn||D.producerFn},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"resettable",{get:function(){return R(this.config.resettable)?this.config.resettable:this.options.resettable},enumerable:!1,configurable:!0}),r.prototype._setState=function(e,r){var i=this;if(void 0===r&&(r=!0),k(e)){var o=e(this._value());this.storeValue=t.__DEV__?this.deepFreeze(o):o}else this.storeValue=e;if(!this.store)return this.store=new n.BehaviorSubject({state:this.storeValue}),void(ot()&&this.store.subscribe((function(t){var e=t.action;e&&Q(i.storeName,e)})));At()?this.handleTransaction():this.dispatch(this.storeValue,r)},r.prototype.reset=function(){var t=this;this.isResettable()?(ot()&&v("Reset"),this._setState((function(){return Object.assign({},t._initialState)})),this.setHasCache(!1)):ot()&&console.warn("You need to enable the reset functionality")},r.prototype.update=function(t){var e;ot()&&v("Update");var n=this._value();e=k(t)?k(this._producerFn)?this._producerFn(n,t):t(n):t;var r=this.akitaPreUpdate(n,o(o({},n),e)),i=bt(n)?r:new n.constructor(r);this._setState(i)},r.prototype.updateStoreConfig=function(t){this.options=o(o({},this.options),t)},r.prototype.akitaPreUpdate=function(t,e){return e},r.prototype.ngOnDestroy=function(){this.destroy()},r.prototype.destroy=function(){!!q&&window.hmrEnabled||this!==W[this.storeName]||(delete W[this.storeName],$(this.storeName),this.setHasCache(!1),this.cache.active.complete(),this.store.complete())},r.prototype.onInit=function(t){var e,n;W[this.storeName]=this,this._setState((function(){return t})),L(this.storeName),this.isResettable()&&(this._initialState=t),ot()&&(e=this.storeName,n=this.constructor.name,e||console.error("@StoreConfig({ name }) is missing in "+n))},r.prototype.dispatch=function(t,e){void 0===e&&(e=!0);var n=void 0;e&&(n=h,y()),this.store.next({state:t,action:n})},r.prototype.watchTransaction=function(){var t=this;Ot().subscribe((function(){t.inTransaction=!1,t.dispatch(t._value())}))},r.prototype.isResettable=function(){return!1!==this.resettable&&(this.resettable||K().resettable)},r.prototype.handleTransaction=function(){this.inTransaction||(this.watchTransaction(),this.inTransaction=!0)},r.prototype.getCacheTTL=function(){return this.cacheConfig&&this.cacheConfig.ttl||K().ttl},r}();function Ct(t){var e,n,r,i=t.state,a=t.ids,u=t.idKey,f=t.newStateOrFn,h=t.preUpdateEntity,l=t.producerFn,y=t.onEntityIdChanges,d={},v=!1;try{for(var g=c(a),b=g.next();!b.done;b=g.next()){var S=b.value;if(!1!==m(i.entities,S)){var E=i.entities[S],P=void 0,_=(P=k(f)?k(l)?l(E,f):f(E):f).hasOwnProperty(u)&&P[u]!==E[u],A=void 0;r=S,_&&(v=!0,r=P[u]);var O=o(o({},E),P);A=bt(E)?O:bt(P)?new E.constructor(O):new P.constructor(O),d[r]=h(E,A)}}}catch(t){e={error:t}}finally{try{b&&!b.done&&(n=g.return)&&n.call(g)}finally{if(e)throw e.error}}var w=i.ids,I=i.entities;if(v){var j=p(a,1)[0],C=i.entities,x=j;C[x];I=s(C,["symbol"==typeof x?x:x+""]),w=i.ids.map((function(t){return t===j?r:t})),y(j,r)}return o(o({},i),{entities:o(o({},I),d),ids:w})}var kt=function(e){function r(t,r){void 0===t&&(t={}),void 0===r&&(r={});var i=e.call(this,o(o({},{entities:{},ids:[],loading:!0,error:null}),t),r)||this;return i.options=r,i.entityActions=new n.Subject,i.entityIdChanges=new n.Subject,i}var s;return i(r,e),Object.defineProperty(r.prototype,"selectEntityAction$",{get:function(){return this.entityActions.asObservable()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"selectEntityIdChanges$",{get:function(){return this.entityIdChanges.asObservable()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"idKey",{get:function(){return this.config.idKey||this.options.idKey||"id"},enumerable:!1,configurable:!0}),r.prototype.set=function(e,n){var i=this;if(void 0===n&&(n={}),!w(e)){ot()&&v("Set Entity");var o=this.akitaPreAddEntity===r.prototype.akitaPreAddEntity;this.setHasCache(!0,{restartTTL:!0}),this._setState((function(t){var r=yt({state:t,entities:e,idKey:i.idKey,preAddEntity:i.akitaPreAddEntity,isNativePreAdd:o});return!1===ut(n.activeId)&&(r.active=n.activeId),r})),this.hasInitialUIState()&&this.handleUICreation(),this.entityActions.next({type:t.EntityActions.Set,ids:this.ids})}},r.prototype.add=function(e,n){void 0===n&&(n={loading:!1});var r=I(e);if(!C(r)){var i=O({state:this._value(),preAddEntity:this.akitaPreAddEntity,entities:r,idKey:this.idKey,options:n});i&&(ot()&&v("Add Entity"),i.newState.loading=n.loading,this._setState((function(){return i.newState})),this.hasInitialUIState()&&this.handleUICreation(!0),this.entityActions.next({type:t.EntityActions.Add,ids:i.newIds}))}},r.prototype.update=function(n,r){var i=this;if(ut(r))e.prototype.update.call(this,n);else{var s,a=[];if(!C(a=k(n)?this.ids.filter((function(t){return n(i.entities[t])})):w(n)?this.ids:I(n)))ot()&&v("Update Entity",a),this._setState((function(t){return Ct({idKey:i.idKey,ids:a,preUpdateEntity:i.akitaPreUpdateEntity,state:t,newStateOrFn:r,producerFn:i._producerFn,onEntityIdChanges:function(t,e){s={oldId:t,newId:e},i.entityIdChanges.next(o(o({},s),{pending:!0}))}})})),s&&this.entityIdChanges.next(o(o({},s),{pending:!1})),this.entityActions.next({type:t.EntityActions.Update,ids:a})}},r.prototype.upsert=function(t,e,n,r){var i=this;void 0===r&&(r={});var s=I(t),a=function(t){return function(e){return m(i.entities,e)===t}},u=k(n)?r.baseClass:n?n.baseClass:void 0,c=k(u),p=s.filter(a(!0)),f=s.filter(a(!1)).map((function(t){var r,s="function"==typeof e?e({}):e,a=k(n)?n(t,s):s,p=o(o({},a),((r={})[i.idKey]=t,r));return c?new u(p):p}));this.update(p,e),this.add(f),ot()&&d("Upsert Entity")},r.prototype.upsertMany=function(e,n){var r,i;void 0===n&&(n={});var s=[],a=[],u={};try{for(var p=c(e),h=p.next();!h.done;h=p.next()){var l=h.value,y=this.akitaPreCheckEntity(l),v=y[this.idKey];if(m(this.entities,v)){var g=this._value().entities[v],b=o(o({},this._value().entities[v]),y),S=n.baseClass?new n.baseClass(b):b,E=(P=this.akitaPreUpdateEntity(g,S))[this.idKey];u[E]=P,a.push(E)}else{var P,_=n.baseClass?new n.baseClass(y):y;E=(P=this.akitaPreAddEntity(_))[this.idKey];s.push(E),u[E]=P}}}catch(t){r={error:t}}finally{try{h&&!h.done&&(i=p.return)&&i.call(p)}finally{if(r)throw r.error}}ot()&&d("Upsert Many"),this._setState((function(t){return o(o({},t),{ids:s.length?f(t.ids,s):t.ids,entities:o(o({},t.entities),u),loading:!!n.loading})})),a.length&&this.entityActions.next({type:t.EntityActions.Update,ids:a}),s.length&&this.entityActions.next({type:t.EntityActions.Add,ids:s}),s.length&&this.hasUIStore()&&this.handleUICreation(!0)},r.prototype.replace=function(t,e){var n,r,i,s=I(t);if(!C(s)){var a={};try{for(var u=c(s),p=u.next();!p.done;p=u.next()){var f=p.value;a[f]=o(o({},e),((i={})[this.idKey]=f,i))}}catch(t){n={error:t}}finally{try{p&&!p.done&&(r=u.return)&&r.call(u)}finally{if(n)throw n.error}}ot()&&v("Replace Entity",t),this._setState((function(t){return o(o({},t),{entities:o(o({},t.entities),a)})}))}},r.prototype.move=function(t,e){var n=this.ids.slice();n.splice(e<0?n.length+e:e,0,n.splice(t,1)[0]),ot()&&v("Move Entity"),this._setState((function(t){return o(o({},t),{entities:o({},t.entities),ids:n})}))},r.prototype.remove=function(e){var n=this;if(!C(this.ids)){var r=R(e),i=[];C(i=k(e)?this.ids.filter((function(t){return e(n.entities[t])})):r?I(e):this.ids)||(ot()&&v("Remove Entity",i),this._setState((function(t){return ct({state:t,ids:i})})),r||this.setHasCache(!1),this.handleUIRemove(i),this.entityActions.next({type:t.EntityActions.Remove,ids:i}))}},r.prototype.updateActive=function(t){var e=I(this.active);ot()&&v("Update Active",e),this.update(e,t)},r.prototype.setActive=function(t){var e=st(t,this.ids,this.active);void 0!==e&&(ot()&&v("Set Active",e),this._setActive(e))},r.prototype.addActive=function(t){var e=this,n=I(t);C(n)||(n.every((function(t){return e.active.indexOf(t)>-1}))||(ot()&&v("Add Active",t),this._setState((function(t){var e=Array.from(new Set(f(t.active,n)));return o(o({},t),{active:e})}))))},r.prototype.removeActive=function(t){var e=this,n=I(t);C(n)||n.some((function(t){return e.active.indexOf(t)>-1}))&&(ot()&&v("Remove Active",t),this._setState((function(t){return o(o({},t),{active:Array.isArray(t.active)?t.active.filter((function(t){return-1===n.indexOf(t)})):null})})))},r.prototype.toggleActive=function(t){var e=this,n=I(t),r=function(t){return function(n){return e.active.includes(n)===t}},i=n.filter(r(!0)),o=n.filter(r(!1));this.removeActive(i),this.addActive(o),ot()&&d("Toggle Active")},r.prototype.createUIStore=function(t,e){void 0===t&&(t={}),void 0===e&&(e={});var n={name:"UI/"+this.storeName,idKey:this.idKey};return this.ui=new xt(t,o(o({},n),e)),this.ui},r.prototype.destroy=function(){e.prototype.destroy.call(this),this.ui instanceof r&&this.ui.destroy(),this.entityActions.complete()},r.prototype.akitaPreUpdateEntity=function(t,e){return e},r.prototype.akitaPreAddEntity=function(t){return t},r.prototype.akitaPreCheckEntity=function(t){return t},Object.defineProperty(r.prototype,"ids",{get:function(){return this._value().ids},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"entities",{get:function(){return this._value().entities},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"active",{get:function(){return this._value().active},enumerable:!1,configurable:!0}),r.prototype._setActive=function(t){this._setState((function(e){return o(o({},e),{active:t})}))},r.prototype.handleUICreation=function(t){var e=this;void 0===t&&(t=!1);var n,r=this.ids,i=k(this.ui._akitaCreateEntityFn),s=function(t){var n,r=e.entities[t],s=i?e.ui._akitaCreateEntityFn(r):e.ui._akitaCreateEntityFn;return o(((n={})[e.idKey]=r[e.idKey],n),s)};n=t?this.ids.filter((function(t){return ut(e.ui.entities[t])})).map(s):r.map(s),t?this.ui.add(n):this.ui.set(n)},r.prototype.hasInitialUIState=function(){return this.hasUIStore()&&!1===ut(this.ui._akitaCreateEntityFn)},r.prototype.handleUIRemove=function(t){this.hasUIStore()&&this.ui.remove(t)},r.prototype.hasUIStore=function(){return this.ui instanceof xt},a([It(),u("design:type",Function),u("design:paramtypes",[Object,Object,Object,Object]),u("design:returntype",void 0)],r.prototype,"upsert",null),a([It(),u("design:type",Function),u("design:paramtypes",["function"==typeof(s="undefined"!=typeof T&&T)?s:Object]),u("design:returntype",void 0)],r.prototype,"toggleActive",null),r}(jt),xt=function(t){function e(e,n){return void 0===e&&(e={}),void 0===n&&(n={}),t.call(this,e,n)||this}return i(e,t),e.prototype.setInitialEntityState=function(t){this._akitaCreateEntityFn=t},e}(kt);function Tt(){return e.filter((function(t){return null!=t}))}function Ut(t){return"string"==typeof t}var Nt=function(){function t(t){this.store=t,this.__store__=t,ot()&&(X[t.storeName]=this)}return t.prototype.select=function(t){var n,r;if(k(t))n=t;else if(Ut(t))n=function(e){return e[t]};else{if(Array.isArray(t))return this.store._select((function(t){return t})).pipe(e.distinctUntilChanged((r=t,function(t,e){var n=k(r[0]);return!1===r.some((function(r){return n?r(t)!==r(e):t[r]!==e[r]}))})),e.map((function(e){return k(t[0])?t.map((function(t){return t(e)})):t.reduce((function(t,n){return t[n]=e[n],t}),{})})));n=function(t){return t}}return this.store._select(n)},t.prototype.selectLoading=function(){return this.select((function(t){return t.loading}))},t.prototype.selectError=function(){return this.select((function(t){return t.error}))},t.prototype.getValue=function(){return this.store._value()},t.prototype.selectHasCache=function(){return this.store._cache().asObservable()},t.prototype.getHasCache=function(){return this.store._cache().value},Object.defineProperty(t.prototype,"config",{get:function(){return this.constructor.akitaQueryConfig},enumerable:!1,configurable:!0}),t}();function Ft(t,e){return function(n){var r=n[t];if(!ut(r))return e?Ut(e)?r[e]:e(r):r}}function Vt(t,e){t.sortBy=t.sortBy||e&&e.sortBy,t.sortByOrder=t.sortByOrder||e&&e.sortByOrder}var Dt=function(t){function r(e,n){void 0===n&&(n={});var r=t.call(this,e)||this;return r.options=n,r.__store__=e,r}return i(r,t),r.prototype.selectAll=function(t){var n=this;return void 0===t&&(t={asObject:!1}),this.select((function(t){return t.entities})).pipe(e.map((function(){return n.getAll(t)})))},r.prototype.getAll=function(t){return void 0===t&&(t={asObject:!1,filterBy:void 0,limitTo:void 0}),t.asObject?rt(this.getValue(),t):(Vt(t,this.config||this.options),nt(this.getValue(),t))},r.prototype.selectMany=function(t,r){return t&&t.length?this.select((function(t){return t.entities})).pipe(e.map((function(e){return n=function(t){return Ft(t,r)(e)},t.reduce((function(t,e,r,i){var o=n(e,r,i);return void 0!==o&&t.push(o),t}),[]);var n})),U()):n.of([])},r.prototype.selectEntity=function(t,n){var r=t;return k(t)&&(r=function(t,e){var n,r;try{for(var i=c(Object.keys(e)),o=i.next();!o.done;o=i.next()){var s=o.value;if(!0===t(e[s]))return s}}catch(t){n={error:t}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}}(t,this.getValue().entities)),this.select((function(t){return t.entities})).pipe(e.map(Ft(r,n)),e.distinctUntilChanged())},r.prototype.getEntity=function(t){return this.getValue().entities[t]},r.prototype.selectActiveId=function(){return this.select((function(t){return t.active}))},r.prototype.getActiveId=function(){return this.getValue().active},r.prototype.selectActive=function(t){var n=this;return S(this.getActive())?this.selectActiveId().pipe(e.switchMap((function(e){return n.selectMany(e,t)}))):this.selectActiveId().pipe(e.switchMap((function(e){return n.selectEntity(e,t)})))},r.prototype.getActive=function(){var t=this,e=this.getActiveId();return S(e)?e.map((function(e){return t.getValue().entities[e]})):gt(e)?this.getEntity(e):void 0},r.prototype.selectCount=function(t){var n=this;return this.select((function(t){return t.entities})).pipe(e.map((function(){return n.getCount(t)})))},r.prototype.getCount=function(t){return k(t)?this.getAll().filter(t).length:this.getValue().ids.length},r.prototype.selectLast=function(t){return this.selectAt((function(t){return t[t.length-1]}),t)},r.prototype.selectFirst=function(t){return this.selectAt((function(t){return t[0]}),t)},r.prototype.selectEntityAction=function(t){if(w(t))return this.store.selectEntityAction$;var n=S(t)?function(t){return t}:function(t){return t.ids},r=I(t);return this.store.selectEntityAction$.pipe(e.filter((function(t){var e=t.type;return r.includes(e)})),e.map((function(t){return n(t)})))},r.prototype.hasEntity=function(t){var e=this;return w(t)?this.getValue().ids.length>0:k(t)?this.getAll().some(t):S(t)?t.every((function(t){return t in e.getValue().entities})):t in this.getValue().entities},r.prototype.hasActive=function(t){var e=this.getValue().active,n=R(t);return Array.isArray(e)?n?e.includes(t):e.length>0:n?e===t:R(e)},r.prototype.createUIQuery=function(){this.ui=new Kt(this.__store__.ui)},r.prototype.selectAt=function(t,n){var r=this;return this.select((function(t){return t.ids})).pipe(e.map(t),e.distinctUntilChanged(),e.switchMap((function(t){return r.selectEntity(t,n)})))},r}(Nt),Kt=function(t){function e(e){return t.call(this,e)||this}return i(e,t),e}(Dt);function Rt(t,e){return 1===e.split(".").length?t:e.split(".").slice(1).join(".").split(".").reduce((function(t,e){return t&&t[e]}),t)}function Bt(t,e,n,r){void 0===r&&(r=!1);var i=e.split(".");if(1===i.length)return o(o({},t),n);t=o({},t);var s=i.length-2;return e.split(".").slice(1).reduce((function(t,e,i){return i!==s?(t[e]=o({},t[e]),t&&t[e]):(t[e]=r||Array.isArray(t[e])||!N(t[e])?n:o(o({},t[e]),n),t&&t[e])}),t),t}var Mt=!1,Ht=new n.ReplaySubject(1);function $t(t){Mt=t}function Lt(){return Mt}function Qt(t){return(e=t)&&k(e.then)||n.isObservable(t)?n.from(t):n.of(t);var e}var qt=function(){function t(t,e){this.query=t,e&&e.resetFn&&K().resettable&&this.onReset(e.resetFn)}return t.prototype.getQuery=function(){return this.query},t.prototype.getStore=function(){return this.getQuery().__store__},t.prototype.isEntityBased=function(t){return gt(t)},t.prototype.selectSource=function(t,e){var n=this;return this.isEntityBased(t)?this.getQuery().selectEntity(t).pipe(Tt()):e?this.getQuery().select((function(t){return Rt(t,n.withStoreName(e))})):this.getQuery().select()},t.prototype.getSource=function(t,e){if(this.isEntityBased(t))return this.getQuery().getEntity(t);var n=this.getQuery().getValue();return e?Rt(n,this.withStoreName(e)):n},t.prototype.withStoreName=function(t){return this.storeName+"."+t},Object.defineProperty(t.prototype,"storeName",{get:function(){return this.getStore().storeName},enumerable:!1,configurable:!0}),t.prototype.updateStore=function(t,e,n,r){var i=this;if(void 0===r&&(r=!1),this.isEntityBased(e)){var s=this.getStore();r?s.replace(e,t):s.update(e,t)}else{if(n)return void this.getStore()._setState((function(e){return Bt(e,i.withStoreName(n),t,!0)}));var a=r?t:function(e){return o(o({},e),t)};this.getStore()._setState(a)}},t.prototype.onReset=function(t){var e=this,n=this.getStore().reset;this.getStore().reset=function(){for(var r=[],i=0;i<arguments.length;i++)r[i]=arguments[i];setTimeout((function(){n.apply(e.getStore(),r),t()}))}},t}(),zt={comparator:function(t,e){return JSON.stringify(t)!==JSON.stringify(e)}};function Jt(t,e){return e.split(".").reduce((function(t,e){return t&&"undefined"!==t[e]?t[e]:void 0}),t)}var Wt=function(t){function r(r,i,s){var a=t.call(this,r)||this;if(a.query=r,a.params=i,a._entityId=s,a.dirty=new n.BehaviorSubject(!1),a.active=!1,a._reset=new n.Subject,a.isDirty$=a.dirty.asObservable().pipe(e.distinctUntilChanged()),a.reset$=a._reset.asObservable(),a.params=o(o({},zt),i),a.params.watchProperty){var u=I(a.params.watchProperty);r instanceof Dt&&u.includes("entities")&&!u.includes("ids")&&u.push("ids"),a.params.watchProperty=u}return a}return i(r,t),r.prototype.reset=function(t){void 0===t&&(t={});var e=this.head;k(t.updateFn)&&(e=this.isEntityBased(this._entityId)?t.updateFn(this.head,this.getQuery().getEntity(this._entityId)):t.updateFn(this.head,this.getQuery().getValue())),d("@DirtyCheck - Revert"),this.updateStore(e,this._entityId),this._reset.next()},r.prototype.setHead=function(){return this.active?this.head=this._getHead():(this.activate(),this.active=!0),this.updateDirtiness(!1),this},r.prototype.isDirty=function(){return!!this.dirty.value},r.prototype.hasHead=function(){return!!this.getHead()},r.prototype.destroy=function(){this.head=null,this.subscription&&this.subscription.unsubscribe(),this._reset&&this._reset.complete()},r.prototype.isPathDirty=function(t){var e=this.getHead(),n=Jt(this.getQuery().getValue(),t),r=Jt(e,t);return this.params.comparator(n,r)},r.prototype.getHead=function(){return this.head},r.prototype.activate=function(){var t=this;this.head=this._getHead();var r=this.params.watchProperty?this.params.watchProperty.map((function(n){return t.query.select((function(t){return t[n]})).pipe(e.map((function(t){return{val:t,__akitaKey:n}})))})):[this.selectSource(this._entityId)];this.subscription=n.combineLatest.apply(void 0,f(r)).pipe(e.skip(1)).subscribe((function(e){if(!ut(t.head)){var n=e.some((function(e){var n=e.__akitaKey?t.head[e.__akitaKey]:t.head,r=e.__akitaKey?e.val:e;return t.params.comparator(n,r)}));t.updateDirtiness(n)}}))},r.prototype.updateDirtiness=function(t){this.dirty.next(t)},r.prototype._getHead=function(){var t=this.getSource(this._entityId);return this.params.watchProperty&&(t=this.getWatchedValues(t)),t},r.prototype.getWatchedValues=function(t){return this.params.watchProperty.reduce((function(e,n){return e[n]=t[n],e}),{})},r}(qt),Xt=function(){function t(t,e){this.query=t,this.entityIds=e,this.entities=new Map}return t.prototype.getEntity=function(t){return this.entities.get(t)},t.prototype.hasEntity=function(t){return this.entities.has(t)},t.prototype.removeEntity=function(t){return this.destroy(t),this.entities.delete(t)},t.prototype.createEntity=function(t,e){return this.entities.set(t,e)},t.prototype.getIds=function(){return ut(this.entityIds)?this.query.getValue().ids:I(this.entityIds)},t.prototype.resolvedIds=function(t){return ut(t)?this.getIds():I(t)},t.prototype.rebase=function(t,e){var n=this;if(void 0===e&&(e={}),gt(t))if(ut(this.entityIds)){for(var r=0,i=t.length;r<i;r++){var o=t[r];if(!1===this.hasEntity(o)){k(e.beforeAdd)&&e.beforeAdd(o);var s=this.instantiatePlugin(o);this.entities.set(o,s),k(e.afterAdd)&&e.afterAdd(s)}}this.entities.forEach((function(r,i){-1===t.indexOf(i)&&(k(e.beforeRemove)&&e.beforeRemove(r),n.removeEntity(i))}))}else{var a=I(this.entityIds);for(r=0,i=a.length;r<i;r++){o=a[r];if(t.indexOf(o)>-1&&!1===this.hasEntity(o)){k(e.beforeAdd)&&e.beforeAdd(o);s=this.instantiatePlugin(o);this.entities.set(o,s),k(e.afterAdd)&&e.afterAdd(s)}else this.entities.forEach((function(r,i){-1===t.indexOf(i)&&!0===n.hasEntity(i)&&(k(e.beforeRemove)&&e.beforeRemove(r),n.removeEntity(i))}))}}else this.getIds().forEach((function(t){n.hasEntity(t)||n.createEntity(t,n.instantiatePlugin(t))}))},t.prototype.selectIds=function(){return this.query.select((function(t){return t.ids}))},t.prototype.activate=function(t){this.rebase(t)},t.prototype.forEachId=function(t,e){for(var n=this.resolvedIds(t),r=0,i=n.length;r<i;r++){var o=n[r];this.hasEntity(o)&&e(this.getEntity(o))}},t}(),Yt=function(t){function r(r,i){void 0===i&&(i={});var s=t.call(this,r,i.entityIds)||this;return s.query=r,s.params=i,s._someDirty=new n.Subject,s.someDirty$=n.merge(s.query.select((function(t){return t.entities})),s._someDirty.asObservable()).pipe(e.auditTime(0),e.map((function(){return s.checkSomeDirty()}))),s.params=o(o({},zt),i),s.activate(),s.selectIds().pipe(e.skip(1)).subscribe((function(e){t.prototype.rebase.call(s,e,{afterAdd:function(t){return t.setHead()}})})),s}return i(r,t),r.prototype.setHead=function(t){if(this.params.entityIds&&t){var e=I(t);if(!1===I(this.params.entityIds).some((function(t){return e.indexOf(t)>-1})))return this}return this.forEachId(t,(function(t){return t.setHead()})),this._someDirty.next(),this},r.prototype.hasHead=function(t){return!!this.entities.has(t)&&this.getEntity(t).hasHead()},r.prototype.reset=function(t,e){void 0===e&&(e={}),this.forEachId(t,(function(t){return t.reset(e)}))},r.prototype.isDirty=function(t,e){if(void 0===e&&(e=!0),this.entities.has(t)){var n=this.getEntity(t);return e?n.isDirty$:n.isDirty()}return!1},r.prototype.someDirty=function(){return this.checkSomeDirty()},r.prototype.isPathDirty=function(t,e){if(this.entities.has(t)){var n=this.getEntity(t).getHead(),r=Jt(this.query.getEntity(t),e),i=Jt(n,e);return this.params.comparator(r,i)}return null},r.prototype.destroy=function(t){this.forEachId(t,(function(t){return t.destroy()})),t||this._someDirty.complete()},r.prototype.instantiatePlugin=function(t){return new Wt(this.query,this.params,t)},r.prototype.checkSomeDirty=function(){var t,e,n=this.resolvedIds();try{for(var r=c(n),i=r.next();!i.done;i=r.next()){var o=i.value;if(this.getEntity(o).isDirty())return!0}}catch(e){t={error:e}}finally{try{i&&!i.done&&(e=r.return)&&e.call(r)}finally{if(t)throw t.error}}return!1},r}(Xt),Gt={pagesControls:!1,range:!1,startWith:1,cacheTimeout:void 0,clearStoreWithCache:!0},Zt=function(t){function r(r,i){void 0===i&&(i={});var s=t.call(this,r,{resetFn:function(){s.initial=!1,s.destroy({clearCache:!0,currentPage:1})}})||this;s.query=r,s.config=i,s.metadata=new Map,s.pages=new Map,s.pagination={currentPage:1,perPage:0,total:0,lastPage:0,data:[]},s.initial=!0,s.isLoading$=s.query.selectLoading().pipe(e.delay(0)),s.config=o(o({},Gt),i);var a=s.config,u=a.startWith,c=a.cacheTimeout;return s.page=new n.BehaviorSubject(u),n.isObservable(c)&&(s.clearCacheSubscription=c.subscribe((function(){return s.clearCache()}))),s}return i(r,t),Object.defineProperty(r.prototype,"pageChanges",{get:function(){return this.page.asObservable()},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"currentPage",{get:function(){return this.pagination.currentPage},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isFirst",{get:function(){return 1===this.currentPage},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"isLast",{get:function(){return this.currentPage===this.pagination.lastPage},enumerable:!1,configurable:!0}),r.prototype.withControls=function(){return this.config.pagesControls=!0,this},r.prototype.withRange=function(){return this.config.range=!0,this},r.prototype.setLoading=function(t){void 0===t&&(t=!0),this.getStore().setLoading(t)},r.prototype.update=function(t){this.pagination=t,this.addPage(t.data)},r.prototype.addPage=function(t){var e=this;this.pages.set(this.currentPage,{ids:t.map((function(t){return t[e.getStore().idKey]}))}),this.getStore().upsertMany(t)},r.prototype.clearCache=function(t){void 0===t&&(t={}),this.initial||(d("@Pagination - Clear Cache"),!1!==t.clearStore&&(this.config.clearStoreWithCache||t.clearStore)&&this.getStore().remove(),this.pages=new Map,this.metadata=new Map),this.initial=!1},r.prototype.clearPage=function(t){this.pages.delete(t)},r.prototype.destroy=function(t){var e=void 0===t?{}:t,n=e.clearCache,r=e.currentPage;this.clearCacheSubscription&&this.clearCacheSubscription.unsubscribe(),n&&this.clearCache(),ut(r)||this.setPage(r),this.initial=!0},r.prototype.isPageActive=function(t){return this.currentPage===t},r.prototype.setPage=function(t){t===this.currentPage&&this.hasPage(t)||this.page.next(this.pagination.currentPage=t)},r.prototype.nextPage=function(){this.currentPage!==this.pagination.lastPage&&this.setPage(this.pagination.currentPage+1)},r.prototype.prevPage=function(){this.pagination.currentPage>1&&this.setPage(this.pagination.currentPage-1)},r.prototype.setLastPage=function(){this.setPage(this.pagination.lastPage)},r.prototype.setFirstPage=function(){this.setPage(1)},r.prototype.hasPage=function(t){return this.pages.has(t)},r.prototype.getPage=function(t){var r=this,i=this.pagination.currentPage;return this.hasPage(i)?this.selectPage(i):(this.setLoading(!0),n.from(t()).pipe(e.switchMap((function(t){return i=t.currentPage,wt((function(){r.setLoading(!1),r.update(t)})),r.selectPage(i)}))))},r.prototype.getQuery=function(){return this.query},r.prototype.refreshCurrentPage=function(){!1===w(this.currentPage)&&(this.clearPage(this.currentPage),this.setPage(this.currentPage))},r.prototype.getFrom=function(){return this.isFirst?1:(this.currentPage-1)*this.pagination.perPage+1},r.prototype.getTo=function(){return this.isLast?this.pagination.total:this.currentPage*this.pagination.perPage},r.prototype.selectPage=function(t){var n=this;return this.query.selectAll({asObject:!0}).pipe(e.take(1),e.map((function(e){var r=o(o({},n.pagination),{data:n.pages.get(t).ids.map((function(t){return e[t]}))}),i=n.config,s=i.range,a=i.pagesControls;return isNaN(n.pagination.total)&&(1===r.lastPage?r.total=r.data?r.data.length:0:r.total=r.perPage*r.lastPage,n.pagination.total=r.total),s&&(r.from=n.getFrom(),r.to=n.getTo()),a&&(r.pageControls=function(t,e){for(var n=Math.ceil(t/e),r=[],i=0;i<n;i++)r.push(i+1);return r}(n.pagination.total,n.pagination.perPage)),r})))},a([b("@Pagination - New Page"),u("design:type",Function),u("design:paramtypes",[Object]),u("design:returntype",void 0)],r.prototype,"update",null),r}(qt);var te,ee,ne=Zt,re=function(t){function n(e,n,r){void 0===r&&(r={});var i=t.call(this,e)||this;return i.query=e,i.factoryFnOrPath=n,i.params=r,i.params=o({debounceTime:300,formKey:"akitaForm",emitEvent:!1,arrControlFactory:function(t){return i.builder.control(t)}},r),i.isRootKeys=!1===gt(n),i.isKeyBased=Ut(n)||i.isRootKeys,i}return i(n,t),n.prototype.setForm=function(t,e){return this.form=t,this.builder=e,this.activate(),this},n.prototype.reset=function(t){var e,n,r=this;n=t||(this.isKeyBased?this.initialValue:this.factoryFnOrPath()),this.isKeyBased&&Object.keys(this.initialValue).forEach((function(t){var e=r.initialValue[t];if(Array.isArray(e)&&r.builder){var n=r.form.controls[t];r.cleanArray(n),e.forEach((function(e,n){r.form.get(t).insert(n,r.params.arrControlFactory(e))}))}})),this.form.patchValue(n,{emitEvent:this.params.emitEvent});var i=this.isKeyBased?Bt(this.getQuery().getValue(),this.getStore().storeName+"."+this.factoryFnOrPath,n):((e={})[this.params.formKey]=n,e);this.updateStore(i)},n.prototype.cleanArray=function(t){for(;0!==t.length;)t.removeAt(0)},n.prototype.resolveInitialValue=function(t,e){var n=this;if(t)return Object.keys(t).reduce((function(t,r){var i=e[r];if(Array.isArray(i)&&n.builder){var o=n.params.arrControlFactory;n.cleanArray(n.form.get(r)),i.forEach((function(t,e){n.form.get(r).insert(e,o(t))}))}return t[r]=e[r],t}),{})},n.prototype.activate=function(){var t,n,r=this;if(this.isKeyBased)if(this.isRootKeys)this.initialValue=this.resolveInitialValue(this.form.value,this.getQuery().getValue()),this.form.patchValue(this.initialValue,{emitEvent:this.params.emitEvent});else{n=this.getStore().storeName+"."+this.factoryFnOrPath;var i=Rt(this.getQuery().getValue(),n);this.initialValue=this.resolveInitialValue(i,i),this.form.patchValue(this.initialValue,{emitEvent:this.params.emitEvent})}else{this.getQuery().getValue()[this.params.formKey]||(d("@PersistNgFormPlugin activate"),this.updateStore(((t={})[this.params.formKey]=this.factoryFnOrPath(),t)));var s=this.getQuery().getValue()[this.params.formKey];this.form.patchValue(s)}this.formChanges=this.form.valueChanges.pipe(e.debounceTime(this.params.debounceTime)).subscribe((function(t){var e;d("@PersistForm - Update"),e=r.isKeyBased?r.isRootKeys?function(e){return o(o({},e),t)}:function(e){return Bt(e,n,t)}:function(){var e;return(e={})[r.params.formKey]=t,e},r.updateStore(e(r.getQuery().getValue()))}))},n.prototype.destroy=function(){this.formChanges&&this.formChanges.unsubscribe(),this.form=null,this.builder=null},n}(qt),ie=function(t){function r(e,n,r){void 0===n&&(n={});var i=t.call(this,e,{resetFn:function(){return i.clear()}})||this;return i.query=e,i.params=n,i._entityId=r,i.skip=!1,i.history={past:[],present:null,future:[]},i.skipUpdate=!1,n.maxAge=n.maxAge?n.maxAge:10,n.comparator=n.comparator||function(){return!0},i.activate(),i}return i(r,t),Object.defineProperty(r.prototype,"hasPast$",{get:function(){return this._hasPast$},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasFuture$",{get:function(){return this._hasFuture$},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasPast",{get:function(){return this.history.past.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hasFuture",{get:function(){return this.history.future.length>0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"property",{get:function(){return this.params.watchProperty},enumerable:!1,configurable:!0}),r.prototype.updateHasHistory=function(){this.hasFutureSubject.next(this.hasFuture),this.hasPastSubject.next(this.hasPast)},r.prototype.activate=function(){var t=this;this.hasPastSubject=new n.BehaviorSubject(!1),this._hasPast$=this.hasPastSubject.asObservable().pipe(e.distinctUntilChanged()),this.hasFutureSubject=new n.BehaviorSubject(!1),this._hasFuture$=this.hasFutureSubject.asObservable().pipe(e.distinctUntilChanged()),this.history.present=this.getSource(this._entityId,this.property),this.subscription=this.selectSource(this._entityId,this.property).pipe(e.pairwise()).subscribe((function(e){var n=p(e,2),r=n[0],i=n[1];if(t.skip)t.skip=!1;else{var o=t.params.comparator(r,i);!t.skipUpdate&&o&&(t.history.past.length===t.params.maxAge&&(t.history.past=t.history.past.slice(1)),t.history.past=f(t.history.past,[r]),t.history.present=i,t.updateHasHistory())}}))},r.prototype.undo=function(){if(this.history.past.length>0){var t=this.history,e=t.past,n=t.present,r=e[e.length-1];this.history.past=e.slice(0,e.length-1),this.history.present=r,this.history.future=f([n],this.history.future),this.update()}},r.prototype.redo=function(){if(this.history.future.length>0){var t=this.history,e=t.past,n=t.present,r=this.history.future[0],i=this.history.future.slice(1);this.history.past=f(e,[n]),this.history.present=r,this.history.future=i,this.update("Redo")}},r.prototype.jumpToPast=function(t){if(!(t<0||t>=this.history.past.length)){var e=this.history,n=e.past,r=e.future,i=e.present,o=n.slice(0,t),s=f(n.slice(t+1),[i],r),a=n[t];this.history.past=o,this.history.present=a,this.history.future=s,this.update()}},r.prototype.jumpToFuture=function(t){if(!(t<0||t>=this.history.future.length)){var e=this.history,n=e.past,r=e.future,i=f(n,[e.present],r.slice(0,t)),o=r[t],s=r.slice(t+1);this.history.past=i,this.history.present=o,this.history.future=s,this.update("Redo")}},r.prototype.jump=function(t){return t>0?this.jumpToFuture(t-1):t<0?this.jumpToPast(this.history.past.length+t):void 0},r.prototype.clear=function(t){this.history=k(t)?t(this.history):{past:[],present:null,future:[]},this.updateHasHistory()},r.prototype.destroy=function(t){void 0===t&&(t=!1),t&&this.clear(),this.subscription.unsubscribe()},r.prototype.ignoreNext=function(){this.skip=!0},r.prototype.update=function(t){void 0===t&&(t="Undo"),this.skipUpdate=!0,d("@StateHistory - "+t),this.updateStore(this.history.present,this._entityId,this.property,!0),this.updateHasHistory(),this.skipUpdate=!1},r}(qt),oe=function(t){function n(n,r){void 0===r&&(r={});var i=t.call(this,n,r.entityIds)||this;return i.query=n,i.params=r,r.maxAge=gt(r.maxAge)?r.maxAge:10,i.activate(),i.selectIds().pipe(e.skip(1)).subscribe((function(t){return i.activate(t)})),i}return i(n,t),n.prototype.redo=function(t){this.forEachId(t,(function(t){return t.redo()}))},n.prototype.undo=function(t){this.forEachId(t,(function(t){return t.undo()}))},n.prototype.hasPast=function(t){if(this.hasEntity(t))return this.getEntity(t).hasPast},n.prototype.hasFuture=function(t){if(this.hasEntity(t))return this.getEntity(t).hasFuture},n.prototype.jumpToFuture=function(t,e){this.forEachId(t,(function(t){return t.jumpToFuture(e)}))},n.prototype.jumpToPast=function(t,e){this.forEachId(t,(function(t){return t.jumpToPast(e)}))},n.prototype.clear=function(t){this.forEachId(t,(function(t){return t.clear()}))},n.prototype.destroy=function(t,e){void 0===e&&(e=!1),this.forEachId(t,(function(t){return t.destroy(e)}))},n.prototype.ignoreNext=function(t){this.forEachId(t,(function(t){return t.ignoreNext()}))},n.prototype.instantiatePlugin=function(t){return new ie(this.query,this.params,t)},n}(Xt);(t.StoreAction||(t.StoreAction={})).Update="UPDATE";var se,ae=((te={})[t.StoreAction.Update]="update",te);(se=t.EntityStoreAction||(t.EntityStoreAction={})).Update="UPDATE",se.AddEntities="ADD_ENTITIES",se.SetEntities="SET_ENTITIES",se.UpdateEntities="UPDATE_ENTITIES",se.RemoveEntities="REMOVE_ENTITIES",se.UpsertEntities="UPSERT_ENTITIES",se.UpsertManyEntities="UPSERT_MANY_ENTITIES";var ue=((ee={})[t.EntityStoreAction.Update]="update",ee[t.EntityStoreAction.AddEntities]="add",ee[t.EntityStoreAction.SetEntities]="set",ee[t.EntityStoreAction.UpdateEntities]="update",ee[t.EntityStoreAction.RemoveEntities]="remove",ee[t.EntityStoreAction.UpsertEntities]="upsert",ee[t.EntityStoreAction.UpsertManyEntities]="upsertMany",ee);function ce(t){return pe(t.akitaConfig.storeName)}function pe(t){var e=W[t];if(w(e))throw new vt(e.storeName+" doesn't exist");return e}function fe(t){return ce(t)}function he(t){return pe(t)}var le=function(){function t(){}return t.prototype.getStoresSnapshot=function(t){void 0===t&&(t=[]);for(var e={},n=t.length>0?t:Object.keys(W),r=0;r<n.length;r++){var i=n[r];"router"!==i&&(e[i]=W[i]._value())}return e},t.prototype.setStoresSnapshot=function(t,n){var r=o({skipStorageUpdate:!1,lazy:!1},n);r.skipStorageUpdate&&$t(!0);var i=t;Ut(t)&&(i=JSON.parse(i));var s=Object.keys(i).length;if(r.lazy)M.pipe(e.filter((function(t){return i.hasOwnProperty(t)})),e.take(s)).subscribe((function(t){return W[t]._setState((function(){return i[t]}))}));else for(var a=function(t,e){var n=e[t];W[n]&&W[n]._setState((function(){return i[n]}))},u=0,c=Object.keys(i);u<c.length;u++)a(u,c);r.skipStorageUpdate&&$t(!1)},t}(),ye=new le;var de=function(){function t(t){this.query=t}return t.prototype.call=function(t,r){var i=this;return r.pipe(e.first(),e.switchMap((function(t){var r=t[i.query.__store__.config.idKey],o=!1;return n.merge(n.of({newId:void 0,oldId:r,pending:!1}),i.query.__store__.selectEntityIdChanges$).pipe(e.filter((function(t){return t.oldId===r})),e.tap((function(t){return o=t.pending})),e.filter((function(t){return t.newId!==r&&!o})),e.switchMap((function(t){return i.query.selectEntity(r=t.newId||r).pipe(e.filter((function(){return!o})))})))}))).subscribe(t)},t}();t.$$addStore=M,t.$$deleteStore=B,t.$$updateStore=H,t.AkitaPlugin=qt,t.DEFAULT_ID_KEY="id",t.DirtyCheckPlugin=Wt,t.EntityCollectionPlugin=Xt,t.EntityDirtyCheckPlugin=Yt,t.EntityService=it,t.EntityStateHistoryPlugin=oe,t.EntityStore=kt,t.EntityUIQuery=Kt,t.EntityUIStore=xt,t.Paginator=ne,t.PaginatorPlugin=Zt,t.PersistNgFormPlugin=re,t.Query=Nt,t.QueryConfig=function(t){return function(e){e.akitaQueryConfig={};for(var n=0,r=Object.keys(t);n<r.length;n++){var i=r[n];e.akitaQueryConfig[i]=t[i]}}},t.QueryEntity=Dt,t.SnapshotManager=le,t.StateHistoryPlugin=ie,t.Store=jt,t.StoreConfig=function(t){return function(e){e.akitaConfig={idKey:"id"};for(var n=0,r=Object.keys(t);n<r.length;n++){var i=r[n];"name"===i?e.akitaConfig.storeName=t[i]:e.akitaConfig[i]=t[i]}}},t.__stores__=W,t.action=b,t.addEntities=O,t.akitaConfig=function(t){D=o(o({},D),t)},t.akitaDevtools=function(t,e){if(void 0===e&&(e={}),!z&&window.__REDUX_DEVTOOLS_EXTENSION__){tt.length&&tt.forEach((function(t){t.unsubscribe?t.unsubscribe():t&&t()})),t&&t.run||((t=t||{}).run=function(t){return t()},e=t);var n=Object.assign({},{name:"Akita",shallow:!0,storesWhitelist:[]},e),r=n.storesWhitelist,i=window.__REDUX_DEVTOOLS_EXTENSION__.connect(n),a={},u=function(t){return!r.length||r.indexOf(t)>-1};tt.push(M.subscribe((function(t){var e;!1!==u(t)&&(a=o(o({},a),((e={})[t]=W[t]._value(),e)),i.send({type:"["+Y(t)+"] - @@INIT"},a))}))),tt.push(B.subscribe((function(t){!1!==u(t)&&(delete a[t],i.send({type:"["+t+"] - Delete Store"},a))}))),tt.push(H.subscribe((function(t){var n,r=t.storeName,c=t.action;if(!1!==u(r)){var p=c.type,f=c.entityIds,h=c.skip,l=s(c,["type","entityIds","skip"]).payload;if(h)g(!1);else{var y=W[r];if(y){if(!1===e.shallow&&a[r])if(JSON.stringify(y._value())===JSON.stringify(a[r]))return;a=o(o({},a),((n={})[r]=y._value(),n));var d=Y(r),v=R(f)?"["+d+"] - "+p+" (ids: "+f+")":"["+d+"] - "+p;if(e.logTrace&&(console.group(v),console.trace(),console.groupEnd()),e.sortAlphabetically){var b=Object.keys(a).sort().reduce((function(t,e){return t[e]=a[e],t}),{});i.send(o({type:v},l),b)}else i.send(o({type:v},l),a)}}}}))),tt.push(i.subscribe((function(e){if("DISPATCH"===e.type){if("COMMIT"===e.payload.type)return void i.init(a);if(e.state)for(var n=JSON.parse(e.state),r=function(e,r){var i=r[e];W[i]&&t.run((function(){W[i]._setState((function(){return n[i]}),!1)}))},o=0,s=Object.keys(n);o<s.length;o++)r(o,s)}})))}},t.applyTransaction=wt,t.arrayAdd=j,t.arrayFind=function(t,n){return function(r){return r.pipe(e.map((function(e){return!1===S(e)?e:x(e,t,n||"id")})),U(),e.map((function(e){return!1===S(e)||S(t)||k(t)?e:e[0]})))}},t.arrayRemove=function(t,e,n){var r,i,o;if(void 0===n&&(n="id"),k(e)?(o=e,i=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return!o.apply(void 0,f(t))}):(r=I(e),i=function(t){return!1===r.includes(N(t)?t[n]:t)}),Array.isArray(t))return t.filter(i)},t.arrayToggle=function(t,e,n){void 0===n&&(n=function(t,e){return t===e});var r=t.findIndex((function(t){return n(e,t)}));return~r?f(t.slice(0,r),t.slice(r+1)):f(t,[e])},t.arrayUpdate=V,t.arrayUpsert=function(t,e,n,r){var i;void 0===r&&(r="id");var s=N(n);return t.some((function(t){return s?t[r]===e:t===e}))?V(t,e,n,r):j(t,s?o(o({},n),((i={})[r]=e,i)):n)},t.byId=function(){return F("id")},t.byKey=F,t.cacheable=function(t,e,r){return void 0===r&&(r={emitNext:!1}),t._cache().value?r.emitNext?n.of(void 0):n.EMPTY:e},t.coerceArray=I,t.combineQueries=function(t){return n.combineLatest(t).pipe(e.auditTime(0))},t.commit=Ot,t.compareValues=et,t.configKey="akitaConfig",t.createEntityQuery=function(t,e){return void 0===e&&(e={}),new Dt(t,e)},t.createEntityStore=function(t,e){return new kt(t,e)},t.createQuery=function(t){return new Nt(t)},t.createStore=function(t,e){return new jt(t,e)},t.currentAction=h,t.dirtyCheckDefaultParams=zt,t.dispatchAdded=L,t.dispatchDeleted=$,t.dispatchUpdate=Q,t.distinctUntilArrayItemChanged=U,t.enableAkitaProdMode=function(){t.__DEV__=!1,q&&(delete window.$$stores,delete window.$$queries)},t.endBatch=_t,t.entitiesToArray=nt,t.entitiesToMap=rt,t.filterNil=function(t){return t.pipe(e.filter((function(t){return null!=t})))},t.filterNilValue=Tt,t.find=x,t.getActiveEntities=st,t.getAkitaConfig=K,t.getEntityStore=fe,t.getEntityStoreByName=he,t.getExitingActives=A,t.getInitialEntitiesState=at,t.getNestedPath=Jt,t.getStore=ce,t.getStoreByName=pe,t.getValue=Rt,t.guid=function(){return Math.random().toString(36).slice(2)},t.hasActiveState=E,t.hasEntity=m,t.isArray=S,t.isDefined=R,t.isDev=ot,t.isEmpty=C,t.isEntityState=ht,t.isFunction=k,t.isMultiActiveState=P,t.isNil=w,t.isNotBrowser=z,t.isNumber=function(t){return!S(t)&&t-parseFloat(t)+1>=0},t.isObject=N,t.isPlainObject=bt,t.isString=Ut,t.isTransactionInProcess=At,t.isUndefined=ut,t.logAction=d,t.persistState=function(t){var n={key:"AkitaStores",enableInNonBrowser:!1,storage:J()?localStorage:t.storage,deserialize:JSON.parse,serialize:JSON.stringify,include:[],select:[],persistOnDestroy:!1,preStorageUpdate:function(t,e){return e},preStoreUpdate:function(t,e){return e},skipStorageUpdate:Lt,preStorageUpdateOperator:function(){return function(t){return t}}},r=Object.assign({},n,t),i=r.storage,s=r.enableInNonBrowser,a=r.deserialize,u=r.serialize,c=r.include,p=r.select,f=r.key,h=r.preStorageUpdate,l=r.persistOnDestroy,y=r.preStorageUpdateOperator,d=r.preStoreUpdate,g=r.skipStorageUpdate;if((!z||s)&&i){var b,m,S=c.length>0,E=p.length>0;S&&(b=c.reduce((function(t,e){k(e)?t.fns.push(e):t[e.split(".")[0]]=e;return t}),{fns:[]})),E&&(m=p.reduce((function(t,e){return t[e.storeName]=e,t}),{}));var P={},_={},A=[],O=[],I=J()&&i===localStorage||function(){try{return"undefined"!=typeof sessionStorage}catch(t){return!1}}()&&i===sessionStorage;return Qt(i.getItem(f)).subscribe((function(t){var n=N(t)?t:a(t||"{}");function r(t){n.$cache=o(o({},n.$cache||{}),t),n=Object.assign({},n,_),O.push(i.setItem(f,I?u(n):n)),function t(e){Qt(e).subscribe((function(){var e=O.shift();e&&t(e)}))}(O.shift())}function s(t,n){P[t]=W[t]._select((function(t){return Rt(t,n)})).pipe(e.skip(1),e.map((function(e){return E&&m[t]?m[t](e):e})),e.filter((function(){return!1===g()})),y()).subscribe((function(e){_[t]=h(t,e),Promise.resolve().then((function(){var e;return r(((e={})[t]=W[t]._cache().getValue(),e))}))}))}function c(t,e,r){if(t in n){v("@PersistState"),e._setState((function(e){return Bt(e,r,d(t,n[t],e))}));var i=!!n.$cache&&n.$cache[t];W[t].setHasCache(i,{restartTTL:!0})}}A.push(B.subscribe((function(t){var e;P[t]&&(!1===l&&r(((e={})[t]=!1,e)),P[t].unsubscribe(),delete P[t])}))),A.push(M.subscribe((function(t){if("router"!==t){var e=W[t];if(S){var n=b[t];if(!n){if(!b.fns.some((function(e){return e(t)})))return;n=t}c(t,e,n),s(t,n)}else c(t,e,t),s(t,t)}}))),Ht.next()})),{destroy:function(){A.forEach((function(t){return t.unsubscribe()}));for(var t=0,e=Object.keys(P);t<e.length;t++){var n=e[t];P[n].unsubscribe()}P={}},clear:function(){i.clear()},clearStore:function(t){w(t)?Qt(i.setItem(f,"{}")).subscribe():Qt(i.getItem(f)).subscribe((function(e){var n=a(e||"{}");n[t]&&(delete n[t],Qt(i.setItem(f,u(n))).subscribe())}))}}}},t.queryConfigKey="akitaQueryConfig",t.removeAllEntities=pt,t.removeEntities=ct,t.resetCustomAction=y,t.resetStores=function(t){t=Object.assign({},{exclude:[]},t);var e=Object.keys(W);wt((function(){var n,r;try{for(var i=c(e),o=i.next();!o.done;o=i.next()){var s=o.value,a=W[s];t.exclude?-1===t.exclude.indexOf(a.storeName)&&a.reset():a.reset()}}catch(t){n={error:t}}finally{try{o&&!o.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}}))},t.resolveActiveEntity=_,t.runEntityStoreAction=function(t,e,n){var r="string"==typeof t?he(t):fe(t);n(r[ue[e]].bind(r))},t.runStoreAction=function(t,e,n){var r="string"==typeof t?pe(t):ce(t);n(r[ae[e]].bind(r))},t.selectPersistStateInit=function(){return Ht.asObservable()},t.setAction=v,t.setEntities=yt,t.setLoading=function(t){return function(r){return n.defer((function(){return t.setLoading(!0),r.pipe(e.finalize((function(){return t.setLoading(!1)})))}))}},t.setLoadingAndError=function(t){return function(r){return n.defer((function(){return t.setLoading(!0),t.setError(null),r.pipe(e.tap({error:function(e){t.setLoading(!1),t.setError(e)},complete:function(){t.setLoading(!1)}}))}))}},t.setSkipAction=g,t.setValue=Bt,t.snapshotManager=ye,t.sortByOptions=Vt,t.startBatch=Pt,t.toBoolean=gt,t.toEntitiesIds=function(t,e){var n,r;void 0===e&&(e="id");var i=[];try{for(var o=c(t),s=o.next();!s.done;s=o.next()){var a=s.value;i.push(a[e])}}catch(t){n={error:t}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(n)throw n.error}}return i},t.toEntitiesObject=ft,t.trackIdChanges=function(t){return function(e){return e.lift(new de(t))}},t.transaction=It,t.transactionManager=Et,t.updateEntities=Ct,t.withTransaction=function(t){return function(n){return n.pipe(e.tap((function(e){return wt((function(){return t(e)}))})))}},t.a=q,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=datorama-akita.umd.min.js.map